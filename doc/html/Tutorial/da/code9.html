<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coding 9 &mdash; DASH 4.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/matlab-io.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/accordion.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="optimalSensor" href="optimalSensor.html" />
    <link rel="prev" title="particleFilter" href="particleFilter.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> DASH
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../welcome.html">Welcome!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Install DASH</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../welcome.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../before-starting.html">Before Starting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../da-primer.html">DA Primer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial-outline.html">Tutorial Outline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dash/outline.html">Introducing DASH</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html">Demos</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gridfile/outline.html">gridfile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stateVector/outline.html">stateVector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ensemble/outline.html">ensemble</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PSM/outline.html">PSM</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="outline.html">DA Algorithms</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="da-algorithms.html">DA Algorithms in DASH</a></li>
<li class="toctree-l3"><a class="reference internal" href="kalmanFilter.html">kalmanFilter</a></li>
<li class="toctree-l3"><a class="reference internal" href="code8.html">Coding 8</a></li>
<li class="toctree-l3"><a class="reference internal" href="particleFilter.html">particleFilter</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Coding 9</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#goal">Goal</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-1-create-particlefilter-object">Step 1: Create <code class="docutils literal notranslate"><span class="pre">particleFilter</span></code> object</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-2-essential-inputs">Step 2: Essential Inputs</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#select-reconstruction-targets"><em>Select Reconstruction Targets</em></a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#step-3-weighting-scheme">Step 3: Weighting Scheme</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-4-run-the-filter">Step 4: Run the filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-5-regrid-state-vector-variables">Step 5: Regrid state vector variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-6-visualize">Step 6: Visualize!</a></li>
<li class="toctree-l4"><a class="reference internal" href="#full-demo">Full Demo</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="optimalSensor.html">optimalSensor</a></li>
<li class="toctree-l3"><a class="reference internal" href="code10.html">Coding 10</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../next-steps.html">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../showcase.html">Showcase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gridMetadata.html">gridMetadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gridfile.html">gridfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stateVector.html">stateVector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ensemble.html">ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ensembleMetadata.html">ensembleMetadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PSM.html">PSM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kalmanFilter.html">kalmanFilter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../particleFilter.html">particleFilter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimalSensor.html">optimalSensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dash.html">dash</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DASH</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../welcome.html">Welcome to the DASH Tutorial!</a> &raquo;</li>
          <li><a href="outline.html">Outline</a> &raquo;</li>
      <li>Coding 9</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/JonKing93/DASH" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="coding-9">
<h1>Coding 9<a class="headerlink" href="#coding-9" title="Permalink to this heading"></a></h1>
<section id="goal">
<h2>Goal<a class="headerlink" href="#goal" title="Permalink to this heading"></a></h2>
<p>Use the <code class="docutils literal notranslate"><span class="pre">particleFilter</span></code> class to run a particle filter assimilation.</p>
</section>
<section id="step-1-create-particlefilter-object">
<h2>Step 1: Create <code class="docutils literal notranslate"><span class="pre">particleFilter</span></code> object<a class="headerlink" href="#step-1-create-particlefilter-object" title="Permalink to this heading"></a></h2>
<p>We’ll start by using the <code class="docutils literal notranslate"><span class="pre">particleFilter</span></code> command to create an object. The syntax is:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">particleFilter</span><span class="w"></span>
</pre></div>
</div>
<p>where <strong>obj</strong> is the new <code class="docutils literal notranslate"><span class="pre">particleFilter</span></code> object. You can optionally use the second input to label the object:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">particleFilter</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>where <strong>label</strong> is a string.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can also use the <code class="docutils literal notranslate"><span class="pre">particleFilter.label</span></code> command to label the object at any later point.</p>
</div>
<section class="accordion"><input type="checkbox" name="collapse" id="lgm-1"><label for="lgm-1"><strong>LGM Demo</strong></label><div class="content"><p>Here, we’ll create a <code class="docutils literal notranslate"><span class="pre">particleFilter</span></code> object for the LGM demo. We’ll also apply a label to the object:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">label</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;LGM Demo&quot;</span><span class="p">;</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">particleFilter</span><span class="p">(</span><span class="n">label</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Inspecting the object:</p>
<div class="input highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">disp</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="output highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">particleFilter</span><span class="w"> </span><span class="s">with</span><span class="w"> </span><span class="s">properties:</span><span class="w"></span>

<span class="w">        </span><span class="n">Observations</span><span class="p">:</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">               </span><span class="n">Prior</span><span class="p">:</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">           </span><span class="n">Estimates</span><span class="p">:</span><span class="w"> </span><span class="n">none</span><span class="w"></span>
<span class="w">       </span><span class="n">Uncertainties</span><span class="p">:</span><span class="w"> </span><span class="n">none</span><span class="w"></span>

<span class="w">    </span><span class="n">Weighting</span><span class="w"> </span><span class="n">Scheme</span><span class="p">:</span><span class="w"> </span><span class="n">Bayesian</span><span class="w"></span>
</pre></div>
</div>
<p>we can see the initialized particle filter. We can see that none of the 4 essential inputs (observations, prior, estimates, and uncertainties) have been set yet. We can also see that the object will use the default Bayesian weighting scheme when running the particle filter algorithm.</p>
</div></section></section>
<section id="step-2-essential-inputs">
<h2>Step 2: Essential Inputs<a class="headerlink" href="#step-2-essential-inputs" title="Permalink to this heading"></a></h2>
<p>Next, we’ll use the <code class="docutils literal notranslate"><span class="pre">prior</span></code>, <code class="docutils literal notranslate"><span class="pre">observations</span></code>, <code class="docutils literal notranslate"><span class="pre">estimates</span></code>, and <code class="docutils literal notranslate"><span class="pre">uncertainties</span></code> commands to provide essential inputs to the particle filter. All four commands use a similar base syntax - each command takes a data array as input, and outputs an updated <code class="docutils literal notranslate"><span class="pre">particleFilter</span></code> object:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">prior</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"></span>
<span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">observations</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="w"></span>
<span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">estimates</span><span class="p">(</span><span class="n">Ye</span><span class="p">)</span><span class="w"></span>
<span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">uncertainties</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<dl class="simple">
<dt><strong>X</strong></dt><dd><p>The prior may either be provided via an <code class="docutils literal notranslate"><span class="pre">ensemble</span></code> object or as a data matrix. If using a matrix, each row should be an element of the state vector, and each column should be an ensemble member.</p>
</dd>
<dt><strong>Y</strong></dt><dd><p>The proxy observations should be a data matrix. Each row holds a particular proxy record and each column holds the values for an assimilation time step. You can use a NaN value when a proxy record does not have values for a particular time step.</p>
</dd>
<dt><strong>Ye</strong></dt><dd><p>The proxy estimates should be a matrix with one row per proxy record, and one column per ensemble member.</p>
</dd>
<dt><strong>R</strong></dt><dd><p>The proxy uncertainties should be a data matrix holding either error-variances or a full error-covariance matrix. If using error variances, the uncertainties should be a column vector with one row per proxy record. If using error-covariances, the matrix should be symmetric with one row and one column per proxy record.</p>
</dd>
</dl>
<p>You can also modify these commands to use different values in different assimilation time steps. (For example, to use an evolving prior). We will not discuss this syntax in the tutorial, but you can read about it in the DASH documentation.</p>
<section id="select-reconstruction-targets">
<h3><em>Select Reconstruction Targets</em><a class="headerlink" href="#select-reconstruction-targets" title="Permalink to this heading"></a></h3>
<p>When providing an assimilation prior, the prior only needs to contain state vector variables that represent reconstruction targets. Since we already generated proxy estimates, we don’t need to assimilate variables used only as forward model inputs. You can use the <code class="docutils literal notranslate"><span class="pre">ensemble.useVariables</span></code> command to restrict an ensemble object to specific state vector variables. The syntax for the command is:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">useVariables</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<dl class="simple">
<dt><strong>variables</strong></dt><dd><p>The input should list the names or indices of specific variables in the state vector ensemble.</p>
</dd>
<dt><strong>obj</strong></dt><dd><p>The output is an updated ensemble object.</p>
</dd>
</dl>
<section class="accordion"><input type="checkbox" name="collapse" id="lgm-2"><label for="lgm-2"><strong>LGM Demo</strong></label><div class="content"><p>We’ll use the four input commands to provide the essential data values for our assimilation. We’ll start by providing the prior using an ensemble object:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Get the ensemble object</span><span class="w"></span>
<span class="n">ens</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ensemble</span><span class="p">(</span><span class="s">&#39;lgm&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c">% Provide the ensemble to the particle filter</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">prior</span><span class="p">(</span><span class="n">ens</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Next, we’ll provide the proxy records. The proxy records are catalogued in <code class="docutils literal notranslate"><span class="pre">uk37.grid</span></code>, so we’ll first use the <code class="docutils literal notranslate"><span class="pre">gridfile.load</span></code> command to load them as a data array:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Load the proxy records</span><span class="w"></span>
<span class="n">proxies</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gridfile</span><span class="p">(</span><span class="s">&#39;uk37&#39;</span><span class="p">);</span><span class="w"></span>
<span class="n">Y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">proxies</span><span class="p">.</span><span class="n">load</span><span class="p">;</span><span class="w"></span>

<span class="c">% Provide the proxy records to the particle filter</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">observations</span><span class="p">(</span><span class="n">Y</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Next, we’ll provide the proxy estimates (Ye) and uncertainties (R). We generated both of these in coding session 7:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Provide proxy estimates and uncertainties</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">estimates</span><span class="p">(</span><span class="n">Ye</span><span class="p">);</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">uncertainties</span><span class="p">(</span><span class="n">R</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Inspecting the updated <code class="docutils literal notranslate"><span class="pre">particleFilter</span></code> object:</p>
<div class="input highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">disp</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="output highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">particleFilter</span><span class="w"> </span><span class="s">with</span><span class="w"> </span><span class="s">properties:</span><span class="w"></span>

<span class="w">                  </span><span class="n">Label</span><span class="p">:</span><span class="w"> </span><span class="n">LGM</span><span class="w"> </span><span class="n">Demo</span><span class="w"></span>

<span class="w">           </span><span class="n">Observations</span><span class="p">:</span><span class="w"> </span><span class="nb">set</span><span class="w"></span>
<span class="w">                  </span><span class="n">Prior</span><span class="p">:</span><span class="w"> </span><span class="n">static</span><span class="w"></span>
<span class="w">              </span><span class="n">Estimates</span><span class="p">:</span><span class="w"> </span><span class="nb">set</span><span class="w"></span>
<span class="w">          </span><span class="n">Uncertainties</span><span class="p">:</span><span class="w"> </span><span class="n">variances</span><span class="w"></span>

<span class="w">      </span><span class="n">Observation</span><span class="w"> </span><span class="n">Sites</span><span class="p">:</span><span class="w"> </span><span class="mi">89</span><span class="w"></span>
<span class="w">    </span><span class="n">State</span><span class="w"> </span><span class="n">Vector</span><span class="w"> </span><span class="n">Length</span><span class="p">:</span><span class="w"> </span><span class="mi">122880</span><span class="w"></span>
<span class="w">       </span><span class="n">Ensemble</span><span class="w"> </span><span class="n">Members</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">                 </span><span class="n">Priors</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">             </span><span class="n">Time</span><span class="w"> </span><span class="n">Steps</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">       </span><span class="n">Weighting</span><span class="w"> </span><span class="n">Scheme</span><span class="p">:</span><span class="w"> </span><span class="n">Bayesian</span><span class="w"></span>
</pre></div>
</div>
<p>we can see that the particle filter now includes all four essential inputs. We can see it uses a static (time-independent) prior, and error-variances for the uncertainties. The output also shows a few key sizes, such as the number of observations sites, prior, assimilation time steps, etc.</p>
</div></section></section>
</section>
<section id="step-3-weighting-scheme">
<h2>Step 3: Weighting Scheme<a class="headerlink" href="#step-3-weighting-scheme" title="Permalink to this heading"></a></h2>
<p>You can adjust the particle filter weighting scheme using the <code class="docutils literal notranslate"><span class="pre">particleFilter.weights</span></code> command. You can use:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">weights</span><span class="p">(</span><span class="s">&#39;bayes&#39;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>to select the default Bayesian weighting scheme, or alternatively:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">weights</span><span class="p">(</span><span class="s">&#39;best&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>to implement the “Best N” weighting scheme. Here, <strong>N</strong> is the number of best particles to use to compute the update.</p>
<section class="accordion"><input type="checkbox" name="collapse" id="lgm-3"><label for="lgm-3"><strong>LGM Demo</strong></label><div class="content"><p>Here, we’ll adjust the particle filter to use the “Best N” weighting scheme rather than the Bayesian scheme. We’ll specifically compute the update using the best 5 particles:</p>
<div class="input highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Use the Best N weighting scheme</span><span class="w"></span>
<span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">weights</span><span class="p">(</span><span class="s">&#39;best&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="output highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">particleFilter</span><span class="w"> </span><span class="s">with</span><span class="w"> </span><span class="s">properties:</span><span class="w"></span>

<span class="w">                  </span><span class="n">Label</span><span class="p">:</span><span class="w"> </span><span class="n">LGM</span><span class="w"> </span><span class="n">Demo</span><span class="w"></span>

<span class="w">           </span><span class="n">Observations</span><span class="p">:</span><span class="w"> </span><span class="nb">set</span><span class="w"></span>
<span class="w">                  </span><span class="n">Prior</span><span class="p">:</span><span class="w"> </span><span class="n">static</span><span class="w"></span>
<span class="w">              </span><span class="n">Estimates</span><span class="p">:</span><span class="w"> </span><span class="nb">set</span><span class="w"></span>
<span class="w">          </span><span class="n">Uncertainties</span><span class="p">:</span><span class="w"> </span><span class="n">variances</span><span class="w"></span>

<span class="w">      </span><span class="n">Observation</span><span class="w"> </span><span class="n">Sites</span><span class="p">:</span><span class="w"> </span><span class="mi">89</span><span class="w"></span>
<span class="w">    </span><span class="n">State</span><span class="w"> </span><span class="n">Vector</span><span class="w"> </span><span class="n">Length</span><span class="p">:</span><span class="w"> </span><span class="mi">122880</span><span class="w"></span>
<span class="w">       </span><span class="n">Ensemble</span><span class="w"> </span><span class="n">Members</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">                 </span><span class="n">Priors</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">             </span><span class="n">Time</span><span class="w"> </span><span class="n">Steps</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">       </span><span class="n">Weighting</span><span class="w"> </span><span class="n">Scheme</span><span class="p">:</span><span class="w"> </span><span class="n">Best</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">particles</span><span class="w"></span>
</pre></div>
</div>
<p>From the output, we can see that the <code class="docutils literal notranslate"><span class="pre">particleFilter</span></code> object will now compute the update using the best 5 particles.</p>
</div></section></section>
<section id="step-4-run-the-filter">
<h2>Step 4: Run the filter<a class="headerlink" href="#step-4-run-the-filter" title="Permalink to this heading"></a></h2>
<p>We’re now ready to run the particle filter algorithm. We’ll do this using the <code class="docutils literal notranslate"><span class="pre">particleFilter.run</span></code> command. The base syntax is:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">run</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>The output is a struct with two fields:</p>
<dl class="simple">
<dt><strong>A</strong></dt><dd><p>This matrix is the update (analysis) for each assimilated time step. Each row is a state vector element, and each column is the update for an assimilated time step.</p>
</dd>
<dt><strong>weights</strong></dt><dd><p>This matrix reports the weights for each particle in each time step. It has one row per ensemble member (particle), and one column per assimilation time step.</p>
</dd>
</dl>
<section class="accordion"><input type="checkbox" name="collapse" id="lgm-4"><label for="lgm-4"><strong>LGM Demo</strong></label><div class="content"><p>Here, we’ll run the particle filter:</p>
<div class="input highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">run</span><span class="w"></span>
</pre></div>
</div>
<div class="output highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"></span>

<span class="w">  </span><span class="nb">struct</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">fields</span><span class="p">:</span><span class="w"></span>

<span class="w">          </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">122880</span>×<span class="mi">1</span><span class="w"> </span><span class="nb">double</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="n">weights</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">16</span>×<span class="mi">1</span><span class="w"> </span><span class="nb">double</span><span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>Inspecting the weights:</p>
<div class="input highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">output</span><span class="p">.</span><span class="n">weights</span><span class="w"></span>
</pre></div>
</div>
<div class="output highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">0</span><span class="w"></span>
<span class="w">    </span><span class="s">0</span><span class="w"></span>
<span class="w">  </span><span class="mf">0.2</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mf">0.2</span><span class="w"></span>
<span class="w">  </span><span class="mf">0.2</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mf">0.2</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="mf">0.2</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
</pre></div>
</div>
<p>we can see the weight applied to each ensemble member. Using Bayes’ formula, ensemble members 3, 9, 10, 13, and 15 were selected as the best 5 particles in the ensemble. The five particles were then given equal weights, and all other particles were given a weight of 0. The updated analysis is the weighted mean of these best 5 particles.</p>
</section>
<section id="step-5-regrid-state-vector-variables">
<h2>Step 5: Regrid state vector variables<a class="headerlink" href="#step-5-regrid-state-vector-variables" title="Permalink to this heading"></a></h2>
<p>At this point, you’ll typically want to start mapping and visualizing the assimilation outputs. However, the assimilated variables are still organized as state vectors, which can hinder visualization. You can use the <code class="docutils literal notranslate"><span class="pre">ensembleMetadata.regrid</span></code> command to (1) extract a variable from a state vector, and (2) return the variable to its original data grid.</p>
<p>Check out the section on <a class="reference internal" href="code8.html#regrid"><span class="std std-ref">regridding state vector variables</span></a> in the Kalman filter tutorial for a detailed discussion of this command.</p>
</section>
<section id="step-6-visualize">
<h2>Step 6: Visualize!<a class="headerlink" href="#step-6-visualize" title="Permalink to this heading"></a></h2>
<p>That’s it, the assimilation is complete! Try visualizing some of the outputs. Plotting data is outside of the scope of DASH, so use whatever mapping and visualization tools you prefer. You may be interested in:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.mathworks.com/help/map/index.html">Matlab’s mapping toolbox</a>, and</p></li>
<li><p><a class="reference external" href="https://www.eoas.ubc.ca/~rich/map.html">The m_map package</a></p></li>
</ul>
<p>and there are many other resources built in to Matlab, as well as online.</p>
</section>
<section id="full-demo">
<h2>Full Demo<a class="headerlink" href="#full-demo" title="Permalink to this heading"></a></h2>
<p>This section recaps all the essential code from the demos and may be useful as a quick reference.</p>
<section class="accordion"><input type="checkbox" name="collapse" id="lgm-full"><label for="lgm-full"><strong>LGM Demo</strong></label><div class="content"><div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Load the proxy data catalogue, and the prior ensemble/its metadata</span><span class="w"></span>
<span class="n">proxies</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gridfile</span><span class="p">(</span><span class="s">&#39;UK37&#39;</span><span class="p">);</span><span class="w"></span>
<span class="n">ens</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ensemble</span><span class="p">(</span><span class="s">&#39;lgm&#39;</span><span class="p">);</span><span class="w"></span>
<span class="n">ensMeta</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ens</span><span class="p">.</span><span class="n">metadata</span><span class="p">;</span><span class="w"></span>

<span class="c">% Create a particle filter object</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">particleFilter</span><span class="p">(</span><span class="s">&#39;LGM demo&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c">% Collect essential inputs</span><span class="w"></span>
<span class="n">X</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ens</span><span class="p">;</span><span class="w"></span>
<span class="n">Y</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">proxies</span><span class="p">.</span><span class="n">load</span><span class="p">;</span><span class="w"></span>
<span class="c">% Ye     (from PSM.estimate)</span><span class="w"></span>
<span class="c">% R      (from PSM.estimate)</span><span class="w"></span>

<span class="c">% Provide essential inputs to the filter</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">prior</span><span class="p">(</span><span class="n">ens</span><span class="p">);</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">observations</span><span class="p">(</span><span class="n">Y</span><span class="p">);</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">estimates</span><span class="p">(</span><span class="n">Ye</span><span class="p">);</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">uncertainties</span><span class="p">(</span><span class="n">R</span><span class="p">);</span><span class="w"></span>

<span class="c">% Select a weighting scheme</span><span class="w"></span>
<span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="n">pf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">weights</span><span class="p">(</span><span class="s">&#39;best&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">);</span><span class="w"></span>

<span class="c">% Run the filter</span><span class="w"></span>
<span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">pf</span><span class="p">.</span><span class="n">run</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="particleFilter.html" class="btn btn-neutral float-left" title="particleFilter" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="optimalSensor.html" class="btn btn-neutral float-right" title="optimalSensor" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Jonathan King.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>